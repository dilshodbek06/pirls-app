generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  TEACHER
  USER
}

enum Grade {
  GRADE_3
  GRADE_4
}

enum QuestionType {
  OPEN // Ochiq savol
  CLOSED // Yopiq savol
}

model User {
  id         String @id @default(cuid())
  email      String @unique
  password   String
  fullName   String
  age        Int
  province   String
  region     String
  schoolName String
  role       Role   @default(TEACHER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  passages Passage[]
  results  Result[]
}

model Passage {
  id       String  @id @default(cuid())
  title    String
  content  String
  imageUrl String?
  grade    Grade

  teacherId String?
  teacher   User?   @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions Question[]
  results   Result[]
}

model Question {
  id                 String       @id @default(cuid())
  content            String
  type               QuestionType
  options            String[]
  correctOptionIndex Int

  // Ochiq savollar uchun (OPEN)
  correctAnswer String?

  passageId String
  passage   Passage @relation(fields: [passageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers Answer[]
}

model Result {
  id          String  @id @default(uuid())
  score       Int // Umumiy ball 85%
  isCompleted Boolean @default(false) // Test yakunlanganligi

  attemptNumber Int

  // Foydalanuvchi bilan bog'lanish
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Matn (Passage) bilan bog'lanish
  passageId String
  passage   Passage @relation(fields: [passageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers Answer[]

  @@unique([userId, passageId, attemptNumber])
}

model Answer {
  id         String  @id @default(uuid())
  userAnswer String?
  isCorrect  Boolean

  // Natija (Result) bilan bog'lanish (Urinishga bog'langan)
  resultId String
  result   Result @relation(fields: [resultId], references: [id])

  // Savol (Question) bilan bog'lanish
  questionId String
  question   Question @relation(fields: [questionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resultId, questionId])
}
